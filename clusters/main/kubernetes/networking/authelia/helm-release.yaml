apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
    name: authelia
    namespace: authelia
spec:
    interval: 15m
    chart:
        spec:
            chart: authelia
            version: 24.1.4
            sourceRef:
                kind: HelmRepository
                name: truecharts
                namespace: flux-system
    releaseName: authelia
    values:
        TZ: America/Chicago
        access_control:
            default_policy: deny
            rules:
                - domain:
                    - ${DOMAIN_0}
                    - '*.${DOMAIN_0}'
                  domain_regex: []
                  networks: []
                  policy: two_factor
                  resources: []
                  subject:
                    - group:${LLDAP_ADMIN_GROUP}
                    - group:${LLDAP_FAMILY_GROUP}
        authentication_backend:
            disable_reset_password: false
            file:
                enabled: false
                password:
                    algorithm: argon2id
                    iterations: 1
                    key_length: 32
                    memory: 1024
                    parallelism: 8
                    salt_length: 16
                path: /config/users_database.yml
            ldap:
                additional_groups_dn: ${LLDAP_GROUPS_DN}
                additional_users_dn: ${LLDAP_USERS_DN}
                base_dn: ${LLDAP_BASE_DN}
                display_name_attribute: displayName
                enabled: true
                group_name_attribute: cn
                groups_filter: ${LLDAP_GROUPS_FILTER}
                implementation: custom
                mail_attribute: mail
                plain_password: ${LLDAP_USER_PASSWORD}
                start_tls: false
                timeout: 5s
                tls:
                    minimum_version: TLS1.2
                    server_name: ""
                    skip_verify: false
                url: ldap://${LLDAP_IP}:3890
                user: ${AUTHELIA_LDAP_USER_VALUE}
                username_attribute: uid
                users_filter: ${LLDAP_USERS_FILTER}
            refresh_interval: 5m
        cnpg:
            main:
                backups:
                    credentials: cloudflare
                    enabled: true
                    retentionPolicy: ""
                    revision: "2"
                cluster:
                    instances: 1
                    singleNode: true
                database: authelia
                enabled: true
                hibernate: false
                mode: recovery
                monitoring:
                    disableDefaultQueries: false
                    enablePodMonitor: true
                password: ${AUTHELIA_CNPG_PASSWORD}
                pgVersion: 16
                pooler:
                    enabled: false
                recovery:
                    credentials: cloudflare
                    enabled: true
                    revision: ""
                    serverName: ""
                user: authelia
        credentials:
            cloudflare:
                accessKey: ${VOLSYNC_ACCESS_KEY}
                bucket: ${VOLSYNC_BUCKET_NAME}
                encrKey: ${AUTHELIA_CONFIG_ENCRYPTION_KEY}
                name: cloudflare
                path: ""
                secretKey: ${VOLSYNC_SECRET_KEY}
                type: s3
                url: ${VOLSYNC_S3_URL}
        default_redirection_url: https://${AUTHELIA_DNS_PREFIX}${DOMAIN_0}
        domain: ${DOMAIN_0}
        identity_providers:
            oidc:
                access_token_lifespan: 1h
                authorize_code_lifespan: 1m
                enable_client_debug_messages: false
                enabled: false
                id_token_lifespan: 1h
                minimum_parameter_entropy: 8
                refresh_token_lifespan: 90m
        ingress:
            main:
                enabled: true
                hosts:
                    - host: ${AUTHELIA_DNS_PREFIX}${DOMAIN_0}
                      paths:
                        - path: /
                          pathType: Prefix
                ingressClassName: external
                integrations:
                    certManager:
                        certificateIssuer: domain-0-le-prod
                        enabled: true
                    traefik:
                        enabled: false
                required: true
        log:
            format: text
            level: info
        notifier:
            disable_startup_check: false
            filesystem:
                enabled: false
                filename: /config/notification.txt
            smtp:
                disable_html_emails: false
                disable_require_tls: false
                enabled: true
                enabledSecret: false
                host: ${LLDAP_SMTP_SERVER_URL}
                identifier: localhost
                plain_password: ${LLDAP_SMTP_PASSWORD}
                port: 587
                sender: ${LLDAP_SMTP_USERNAME}
                startup_check_address: ${AUTHELIA_CHECK_ADDRESS}
                subject: '[Authelia] {title}'
                timeout: 5s
                tls:
                    minimum_version: TLS1.2
                    server_name: ""
                    skip_verify: false
                username: ${LLDAP_SMTP_USERNAME}
        ntp:
            address: time.cloudflare.com:123
            disable_failure: true
            disable_startup_check: false
            max_desync: 3s
            version: 4
        password_policy:
            enabled: false
            standard:
                enabled: false
                max_length: 0
                min_length: 8
                require_lowercase: false
                require_number: false
                require_special: false
                require_uppercase: false
            zxcvbn:
                enabled: false
                min_score: 3
        persistence:
            config:
                enabled: true
                mountPath: /config
                readOnly: false
                storageClass: ""
                volsync:
                    - credentials: cloudflare
                      dest:
                        enabled: true
                      name: authelia-config
                      src:
                        enabled: false
                      type: restic
        redis:
            enabled: true
            includeCommon: true
        redisProvider:
            database_index: 0
            high_availability:
                enabled: false
                enabledSecret: false
                route_by_latency: false
                route_randomly: false
                sentinel_name: mysentinel
            maximum_active_connections: 8
            minimum_idle_connections: 0
            port: 6379
            tls:
                enabled: false
                minimum_version: TLS1.2
                server_name: ""
                skip_verify: false
            username: ""
        regulation:
            ban_time: 5m
            find_time: 2m
            max_retries: 3
        release_name: authelia
        resources: {}
        securityContext:
            container:
                UMASK: "0022"
        server:
            path: ""
            port: 9091
            read_buffer_size: 4096
            write_buffer_size: 4096
        service:
            main:
                enabled: true
                loadBalancerIP: ${AUTHELIA_IP}
                ports:
                    main:
                        port: 9091
                        targetPort: 9091
                type: LoadBalancer
        session:
            expiration: 1h
            inactivity: 5m
            name: authelia_session
            remember_me_duration: 5M
            same_site: lax
        storage:
            postgres:
                database: authelia
                port: 5432
                sslmode: disable
                timeout: 5s
                username: authelia
        theme: auto
        totp:
            issuer: ""
            period: 30
            skew: 1
        workload:
            main:
                podSpec:
                    containers:
                        main:
                            args:
                                - --config=/configuration.yaml
                            command:
                                - authelia
                            envFrom:
                                - configMapRef:
                                    name: authelia-paths
                            probes:
                                liveness:
                                    path: /api/health
                                    type: http
                                readiness:
                                    path: /api/health
                                    type: http
                                startup:
                                    path: /api/health
                                    type: http
                replicas: 2
                strategy: RollingUpdate
                type: Deployment
